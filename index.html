<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PropTech - Catálogo de Empreendimentos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0d6efd;
            --primary-dark: #0b5ed7;
            --secondary: #6c757d;
            --light-bg: #f8f9fa;
            --white: #ffffff;
            --border-color: #dee2e6;
            --text-dark: #212529;
            --text-muted: #6c757d;
            --danger: #dc3545;
            --font-family: 'Inter', sans-serif;
            --border-radius: 12px;
            --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--font-family); }
        body { background-color: var(--light-bg); color: var(--text-dark); -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }

        /* --- Animations --- */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- UTILITIES & LAYOUT --- */
        .hidden { display: none !important; }
        .container { width: 90%; max-width: 1280px; margin: 0 auto; }
        .page { animation: fadeInUp 0.6s ease-out forwards; }
        
        /* --- HEADER --- */
        .header { background-color: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border-color); padding: 1rem 0; position: sticky; top: 0; z-index: 1000; }
        .navbar { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.75rem; font-weight: 800; color: var(--primary); cursor: pointer; }
        .nav-links a { color: var(--text-dark); text-decoration: none; margin-left: 2rem; font-weight: 500; cursor: pointer; position: relative; transition: color 0.3s; }
        .nav-links a::after { content: ''; position: absolute; width: 0; height: 2px; bottom: -5px; left: 50%; background-color: var(--primary); transition: all 0.3s ease-out; }
        .nav-links a:hover { color: var(--primary); }
        .nav-links a:hover::after { width: 100%; left: 0; }

        /* --- HERO SECTION --- */
        .hero { position: relative; overflow: hidden; color: var(--white); padding: 8rem 0; text-align: center; display: flex; align-items: center; justify-content: center; min-height: 60vh; }
        .hero::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)); z-index: 1; }
        .hero-background { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: url('https://images.unsplash.com/photo-1582407947304-fd86f028f716?q=80&w=1992&auto=format&fit=crop') no-repeat center center/cover; }
        .hero-content { position: relative; z-index: 2; animation: fadeInUp 0.8s 0.2s ease-out forwards; opacity: 0; }
        .hero h1 { font-size: 3.5rem; font-weight: 800; margin-bottom: 1rem; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .hero p { font-size: 1.25rem; max-width: 600px; margin: 0 auto; }

        /* --- CATALOG PAGE --- */
        .catalog-section { padding: 5rem 0; }
        .section-title { text-align: center; font-size: 2.5rem; font-weight: 800; margin-bottom: 3rem; }
        .property-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 2.5rem; }
        .property-card { background: var(--white); border-radius: var(--border-radius); overflow: hidden; box-shadow: var(--shadow-md); transition: transform 0.3s, box-shadow 0.3s; cursor: pointer; display: flex; flex-direction: column; }
        .property-card:hover { transform: translateY(-8px); box-shadow: var(--shadow-lg); }
        .property-card-img-wrapper { height: 220px; overflow: hidden; position: relative; }
        .property-card-img-wrapper img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.4s ease; }
        .property-card:hover img { transform: scale(1.05); }
        .property-card-status { position: absolute; top: 1rem; right: 1rem; background-color: rgba(0, 0, 0, 0.6); color: var(--white); padding: 0.25rem 0.75rem; border-radius: 6px; font-size: 0.8rem; font-weight: 500; }
        .property-card-content { padding: 1.5rem; flex-grow: 1; display: flex; flex-direction: column; }
        .property-card-title { font-size: 1.3rem; font-weight: 700; margin-bottom: 0.5rem; color: var(--text-dark); }
        .property-card-location { color: var(--text-muted); margin-bottom: 1rem; }
        .property-card-price { font-size: 1.2rem; font-weight: 700; color: var(--primary); margin-top: auto; }

        /* --- DETAILS PAGE --- */
        .details-grid { display: grid; grid-template-columns: 1fr; gap: 3rem; }
        @media (min-width: 992px) { .details-grid { grid-template-columns: 2fr 1fr; } }
        .details-info h3, .admin-form-section h3 { font-size: 1.5rem; margin-bottom: 1rem; border-bottom: 2px solid var(--primary); padding-bottom: 0.5rem; margin-top: 2rem; }
        .features-grid li { background: var(--white); border: 1px solid var(--border-color); }
        .features-grid i { color: var(--primary); }
        .contact-card { background: var(--white); border: 1px solid var(--border-color); padding: 2rem; border-radius: var(--border-radius); position: sticky; top: 120px; box-shadow: var(--shadow-md); }

        /* --- LOGIN & ADMIN PAGES --- */
        .login-container { max-width: 420px; margin: 5rem auto; }
        .admin-tabs button { color: var(--text-muted); }
        .admin-tabs button.active { color: var(--primary); border-bottom-color: var(--primary); }
        .admin-table { background: var(--white); box-shadow: var(--shadow-md); border: 1px solid var(--border-color); }
        .admin-table th, .admin-table td { padding: 1.25rem; border-bottom: 1px solid var(--border-color); }
        .admin-table .actions a.delete-btn { color: var(--danger); }

        /* --- SHARED FORM STYLES --- */
        .form-wrapper { background: var(--white); padding: 2.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow-md); }
        .form-group label { font-weight: 600; color: var(--text-muted); }
        .form-control { background-color: var(--white); color: var(--text-dark); width: 100%; padding: 0.85rem 1rem; border: 1px solid var(--border-color); border-radius: 8px; transition: border-color 0.3s, box-shadow 0.3s; }
        .form-control:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.15); outline: none; }
        .btn { padding: 1rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; border: none; text-transform: uppercase; letter-spacing: 0.5px; }
        .btn-primary { background: var(--primary); color: var(--white); box-shadow: 0 4px 15px rgba(13, 110, 253, 0.2); }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-2px); box-shadow: 0 7px 20px rgba(13, 110, 253, 0.3); }

        /* --- FOOTER --- */
        .footer { background-color: var(--text-dark); color: var(--text-muted); padding: 4rem 0; text-align: center; }
    </style>
</head>
<body>

    <header class="header">
        <div class="container navbar">
            <div class="logo">PropTech</div>
            <nav class="nav-links" id="nav-links">
                <a data-page="catalog">Empreendimentos</a>
                <a data-page="login">Área Restrita</a>
            </nav>
            <nav class="nav-links hidden" id="nav-links-admin">
                <a data-page="admin">Painel</a>
                <a id="logoutBtn">Sair</a>
            </nav>
        </div>
    </header>

    <main id="main-content">
        <!-- PAGE: Catalog -->
        <div id="page-catalog" class="page">
            <section class="hero"><div class="hero-background"></div><div class="hero-content"><h1>Encontre o seu imóvel de sonho</h1><p>Os melhores empreendimentos nos locais mais desejados.</p></div></section>
            <section class="catalog-section"><div class="container"><h2 class="section-title">Nossos Empreendimentos</h2><div class="property-grid" id="property-grid"></div></div></section>
        </div>

        <!-- PAGE: Details (structure is the same, styles will apply) -->
        <div id="page-details" class="page hidden"><div class="container"><a class="back-to-catalog"><i class="fas fa-arrow-left"></i> Voltar para o catálogo</a><header class="details-header"><h1 class="details-title" id="details-title"></h1><p class="details-location" id="details-location"></p></header><div class="details-grid"><div class="details-main"><div class="details-gallery" id="details-gallery"></div><div class="details-info"><h3>Descrição</h3><p class="details-description" id="details-description"></p><h3>Itens de Lazer</h3><ul class="features-grid" id="details-lazer"></ul><h3>Diferenciais</h3><ul class="features-grid" id="details-diferenciais"></ul><h3>Detalhes Técnicos</h3><ul class="features-grid" id="details-tecnicos"></ul></div></div><aside class="details-sidebar"><div class="contact-card"><h3 id="details-price"></h3><p>Preencha o formulário para receber mais informações.</p><form id="contactForm"><div class="form-group"><label for="name">Nome</label><input type="text" id="name" class="form-control" required></div><div class="form-group"><label for="email">Email</label><input type="email" id="email" class="form-control" required></div><button type="submit" class="btn btn-primary">Pedir Informações</button></form></div></aside></div></div></div>

        <!-- PAGE: Login -->
        <div id="page-login" class="page hidden"><div class="login-container form-wrapper"><h2>Área Restrita</h2><form id="loginForm"><div class="form-group"><label for="login-email">Email</label><input type="email" id="login-email" class="form-control" value="admin@proptech.com" required></div><div class="form-group"><label for="login-password">Senha</label><input type="password" id="login-password" class="form-control" value="admin" required></div><button type="submit" class="btn btn-primary">Entrar</button><p id="login-error" class="error-message hidden">Credenciais inválidas.</p></form></div></div>

        <!-- PAGE: Admin Dashboard -->
        <div id="page-admin" class="page hidden">
            <div class="container">
                <div class="admin-tabs" id="admin-tabs"><button class="active" data-tab="properties">Gerir Empreendimentos</button><button data-tab="users" id="admin-users-tab">Gerir Utilizadores</button></div>
                <div id="tab-content-properties"><div class="admin-header"><h2>Meus Empreendimentos</h2><button class="btn btn-primary btn-small" id="addPropertyBtn"><i class="fas fa-plus"></i> Adicionar Empreendimento</button></div><div class="admin-table-wrapper"><table class="admin-table"><thead><tr><th>Empreendimento</th><th>Localização</th><th>Status</th><th>Ações</th></tr></thead><tbody id="admin-property-table-body"></tbody></table></div></div>
                <div id="tab-content-users" class="hidden"><div class="admin-header"><h2>Utilizadores do Sistema</h2><button class="btn btn-primary btn-small" id="addUserBtn"><i class="fas fa-plus"></i> Adicionar Utilizador</button></div><div class="admin-table-wrapper"><table class="admin-table"><thead><tr><th>Email</th><th>Role</th><th>Ações</th></tr></thead><tbody id="admin-user-table-body"></tbody></table></div></div>
            </div>
        </div>

        <!-- PAGE: Admin Property Form -->
        <div id="page-admin-property-form" class="page hidden">
            <div class="container">
                <div class="form-wrapper">
                    <h2 id="admin-property-form-title"></h2>
                    <form id="admin-property-form">
                        <input type="hidden" id="property-id">
                        <div class="admin-form-section"><h3>Informações Principais</h3><div class="admin-form-grid"><div class="form-group"><label for="emp_nome">Nome do Empreendimento</label><input type="text" id="emp_nome" class="form-control" required></div><div class="form-group"><label for="emp_apelido">Apelido</label><input type="text" id="emp_apelido" class="form-control"></div><div class="form-group"><label for="emp_endereco">Endereço Completo</label><input type="text" id="emp_endereco" class="form-control"></div><div class="form-group"><label for="regiao">Região</label><input type="text" id="regiao" class="form-control"></div><div class="form-group full-width"><label for="emp_descricao">Descrição</label><textarea id="emp_descricao" class="form-control" rows="5"></textarea></div></div></div>
                        <div class="admin-form-section"><h3>Detalhes do Imóvel</h3><div class="admin-form-grid"><div class="form-group"><label for="emp_metragens">Metragens (ex: 85m², 120m²)</label><input type="text" id="emp_metragens" class="form-control"></div><div class="form-group"><label for="emp_suites">Nº de Suítes</label><input type="text" id="emp_suites" class="form-control"></div><div class="form-group"><label for="emp_banheiros">Nº de Banheiros</label><input type="text" id="emp_banheiros" class="form-control"></div><div class="form-group"><label for="emp_vagas">Nº de Vagas</label><input type="text" id="emp_vagas" class="form-control"></div><div class="form-group"><label for="area_terreno">Área do Terreno (m²)</label><input type="number" id="area_terreno" class="form-control"></div><div class="form-group"><label for="area_construcao">Área de Construção (m²)</label><input type="number" id="area_construcao" class="form-control"></div><div class="form-group"><label for="numero_torres">Nº de Torres</label><input type="number" id="numero_torres" class="form-control"></div><div class="form-group"><label for="numero_apartamentos">Nº de Apartamentos</label><input type="number" id="numero_apartamentos" class="form-control"></div></div></div>
                        <div class="admin-form-section"><h3>Valores e Status</h3><div class="admin-form-grid"><div class="form-group"><label for="valor_inicial">Valor Inicial (R$)</label><input type="number" id="valor_inicial" class="form-control"></div><div class="form-group"><label for="valor_final">Valor Final (R$)</label><input type="number" id="valor_final" class="form-control"></div><div class="form-group"><label for="emp_status">Status</label><select id="emp_status" class="form-control"><option>Breve Lançamento</option><option>Em Obras</option><option>Pronto para Morar</option></select></div><div class="form-group"><label for="emp_previsao">Previsão de Entrega</label><input type="text" id="emp_previsao" class="form-control" placeholder="ex: Dez/2025"></div></div></div>
                        <div class="admin-form-section"><h3>Características e Parceiros</h3><div class="admin-form-grid"><div class="form-group full-width"><label for="emp_itens_de_lazer">Itens de Lazer (separados por vírgula)</label><textarea id="emp_itens_de_lazer" class="form-control"></textarea></div><div class="form-group full-width"><label for="emp_diferenciais">Diferenciais (separados por vírgula)</label><textarea id="emp_diferenciais" class="form-control"></textarea></div><div class="form-group"><label for="emp_construtora">Construtora</label><input type="text" id="emp_construtora" class="form-control"></div><div class="form-group"><label for="emp_incorporadora">Incorporadora</label><input type="text" id="emp_incorporadora" class="form-control"></div><div class="form-group"><label for="emp_arquitetura">Arquitetura</label><input type="text" id="emp_arquitetura" class="form-control"></div><div class="form-group"><label for="emp_link">Link do Hotsite</label><input type="url" id="emp_link" class="form-control"></div></div></div>
                        <div class="admin-form-section"><h3>Arquivos</h3><div id="files-container"></div><button type="button" class="btn btn-small" id="add-file-btn"><i class="fas fa-plus"></i> Adicionar Arquivo</button></div>
                        <button type="submit" class="btn btn-primary" style="margin-top: 2rem;">Salvar Empreendimento</button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- PAGE: Admin User Form -->
        <div id="page-admin-user-form" class="page hidden">
            <div class="container">
                <div class="form-wrapper">
                    <h2>Adicionar Novo Utilizador</h2>
                    <form id="admin-user-form">
                        <div class="form-group"><label for="user-email">Email</label><input type="email" id="user-email" class="form-control" required></div>
                        <div class="form-group"><label for="user-password">Senha</label><input type="password" id="user-password" class="form-control" required></div>
                        <div class="form-group"><label for="user-role">Role</label><select id="user-role" class="form-control"><option value="user">Utilizador</option><option value="admin">Admin</option></select></div>
                        <button type="submit" class="btn btn-primary">Salvar Utilizador</button>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer"><div class="container"><p>&copy; 2024 PropTech. Todos os direitos reservados.</p></div></footer>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- DATABASE & STATE ---
        const DB_KEY = 'proptech_multiuser_db_light_premium';
        let currentUser = null;
        let dbData = {};

        const initialData = {
            users: [{ id: 1, email: 'admin@proptech.com', password: 'admin', role: 'admin' }, { id: 2, email: 'user@proptech.com', password: 'user', role: 'user' }],
            workspaces: {
                '1': [{
                    id: 101, ownerId: 1, imob_id: 'IMB001', emp_nome: 'Residencial Vista do Vale (Admin)', emp_apelido: 'Vista do Vale', emp_endereco: 'Av. das Flores, 123, São José dos Campos, SP', regiao: 'Zona Oeste', emp_descricao: 'Empreendimento de exemplo pertencente ao Admin.', emp_itens_de_lazer: ['Piscina', 'Academia'], emp_diferenciais: ['Varanda Gourmet'], valor_inicial: 680000, emp_status: 'Em Obras',
                    arquivos: [{ id: 1, tipo: 'image', link: 'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?q=80&w=2070&auto=format&fit=crop' }]
                }],
                '2': [{
                    id: 201, ownerId: 2, imob_id: 'IMB002', emp_nome: 'Condomínio Morada do Sol (User)', emp_apelido: 'Morada do Sol', emp_endereco: 'Rua das Palmeiras, 456, Jacareí, SP', regiao: 'Centro', emp_descricao: 'Empreendimento de exemplo pertencente ao User.', emp_itens_de_lazer: ['Salão de Festas', 'Playground'], emp_diferenciais: ['Portaria 24h'], valor_inicial: 450000, emp_status: 'Pronto para Morar',
                    arquivos: [{ id: 2, tipo: 'image', link: 'https://images.unsplash.com/photo-1600585154340-be6161a56a0c?q=80&w=2070&auto=format&fit=crop' }]
                }]
            }
        };

        const db = {
            load: () => {
                const data = localStorage.getItem(DB_KEY);
                dbData = data ? JSON.parse(data) : initialData;
            },
            save: () => {
                localStorage.setItem(DB_KEY, JSON.stringify(dbData));
            }
        };

        // --- DOM ELEMENTS & LOGIC ---
        const mainContent = document.getElementById('main-content');
        const pages = mainContent.querySelectorAll('.page');
        const navLinks = document.getElementById('nav-links');
        const navLinksAdmin = document.getElementById('nav-links-admin');
        const logo = document.querySelector('.logo');
        const adminPropertyFormEl = document.getElementById('page-admin-property-form');
        const adminUserFormEl = document.getElementById('page-admin-user-form');

        const renderAll = () => {
            renderCatalog();
            if (currentUser) {
                renderAdminPropertyTable();
                if (currentUser.role === 'admin') {
                    renderAdminUserTable();
                }
            }
        };

        const renderCatalog = () => {
            const grid = document.getElementById('property-grid');
            grid.innerHTML = '';
            const allProperties = Object.values(dbData.workspaces).flat();
            if(allProperties.length === 0) {
                grid.innerHTML = '<p>Nenhum empreendimento cadastrado no momento.</p>';
                return;
            }
            allProperties.forEach(prop => {
                const mainImage = prop.arquivos.find(f => f.tipo === 'image')?.link || 'https://placehold.co/600x400/e9ecef/6c757d?text=Sem+Imagem';
                grid.innerHTML += `<div class="property-card" data-id="${prop.id}" data-owner="${prop.ownerId}"><div class="property-card-img-wrapper"><img src="${mainImage}" alt="${prop.emp_nome}"><div class="property-card-status">${prop.emp_status}</div></div><div class="property-card-content"><h3 class="property-card-title">${prop.emp_nome}</h3><p class="property-card-location"><i class="fas fa-map-marker-alt"></i> ${prop.regiao || ''}</p><p class="property-card-price">A partir de ${new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(prop.valor_inicial)}</p></div></div>`;
            });
        };

        const renderAdminPropertyTable = () => {
            const tableBody = document.getElementById('admin-property-table-body');
            tableBody.innerHTML = '';
            const userProperties = dbData.workspaces[currentUser.id] || [];
            if(userProperties.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4">Ainda não adicionou nenhum empreendimento.</td></tr>';
                return;
            }
            userProperties.forEach(prop => {
                tableBody.innerHTML += `<tr data-id="${prop.id}"><td>${prop.emp_nome}</td><td>${prop.emp_endereco}</td><td>${prop.emp_status}</td><td class="actions"><a class="edit-btn">Editar</a><a class="delete-btn">Apagar</a></td></tr>`;
            });
        };

        const renderAdminUserTable = () => {
            const tableBody = document.getElementById('admin-user-table-body');
            tableBody.innerHTML = '';
            dbData.users.forEach(user => {
                tableBody.innerHTML += `<tr data-id="${user.id}"><td>${user.email}</td><td>${user.role}</td><td class="actions">${user.id !== 1 ? '<a class="delete-user-btn">Apagar</a>' : 'Admin Principal'}</td></tr>`;
            });
        };
        
        const populateDetailsPage = (id, ownerId) => {
            const prop = dbData.workspaces[ownerId]?.find(p => p.id == id);
            if (!prop) return;
            
            document.getElementById('details-title').textContent = prop.emp_nome;
            document.getElementById('details-location').innerHTML = `<i class="fas fa-map-marker-alt"></i> ${prop.emp_endereco}`;
            document.getElementById('details-description').textContent = prop.emp_descricao;
            document.getElementById('details-price').textContent = `A partir de ${new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(prop.valor_inicial)}`;

            const gallery = document.getElementById('details-gallery');
            gallery.innerHTML = '';
            prop.arquivos.forEach(file => {
                if (file.tipo === 'image') {
                    gallery.innerHTML += `<img src="${file.link}" alt="Imagem de ${prop.emp_nome}">`;
                } else {
                    gallery.innerHTML += `<a href="${file.link}" target="_blank" class="file-placeholder"><i class="fas fa-file-${file.tipo}"></i><span>Ver ${file.tipo.toUpperCase()}</span></a>`;
                }
            });

            const renderFeatures = (containerId, items) => {
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                if(items && items.length > 0 && items[0]) {
                    items.forEach(item => container.innerHTML += `<li><i class="fas fa-check"></i> ${item}</li>`);
                } else {
                    container.innerHTML = '<li>Nenhuma informação disponível.</li>';
                }
            };
            
            const technicalDetails = [`Construtora: ${prop.emp_construtora || 'N/D'}`, `Incorporadora: ${prop.emp_incorporadora || 'N/D'}`, `Arquitetura: ${prop.emp_arquitetura || 'N/D'}`, `Área do Terreno: ${prop.area_terreno ? prop.area_terreno + ' m²' : 'N/D'}`, `Nº de Torres: ${prop.numero_torres || 'N/D'}`, `Nº de Apartamentos: ${prop.numero_apartamentos || 'N/D'}`];
            
            renderFeatures('details-lazer', prop.emp_itens_de_lazer);
            renderFeatures('details-diferenciais', prop.emp_diferenciais);
            renderFeatures('details-tecnicos', technicalDetails);
        };

        const showPage = (pageId) => {
            mainContent.style.animation = 'none';
            mainContent.offsetHeight; /* Trigger reflow */
            mainContent.style.animation = null; 

            pages.forEach(p => p.classList.add('hidden'));
            const page = document.getElementById(`page-${pageId}`);
            if(page) page.classList.remove('hidden');
            else document.getElementById('page-catalog').classList.remove('hidden');
            window.scrollTo(0, 0);
        };

        const updateNav = () => {
            navLinks.classList.toggle('hidden', currentUser);
            navLinksAdmin.classList.toggle('hidden', !currentUser);
            document.getElementById('admin-users-tab').classList.toggle('hidden', !currentUser || currentUser.role !== 'admin');
        };

        // --- EVENT LISTENERS ---
        logo.addEventListener('click', () => showPage('catalog'));
        navLinks.addEventListener('click', (e) => { if(e.target.matches('a')) showPage(e.target.dataset.page); });
        navLinksAdmin.addEventListener('click', (e) => { if(e.target.matches('a') && e.target.id !== 'logoutBtn') showPage(e.target.dataset.page); });
        
        document.getElementById('logoutBtn').addEventListener('click', () => {
            currentUser = null;
            updateNav();
            showPage('catalog');
        });

        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-password').value;
            const user = dbData.users.find(u => u.email === email && u.password === pass);
            
            if (user) {
                currentUser = user;
                document.getElementById('login-error').classList.add('hidden');
                updateNav();
                renderAll();
                showPage('admin');
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        });
        
        mainContent.addEventListener('click', (e) => {
            const propertyCard = e.target.closest('.property-card');
            if (propertyCard) {
                const propId = propertyCard.dataset.id;
                const ownerId = propertyCard.dataset.owner;
                populateDetailsPage(propId, ownerId);
                showPage('details');
            }
            if (e.target.closest('.back-to-catalog')) {
                e.preventDefault();
                showPage('catalog');
            }
        });

        document.getElementById('admin-tabs').addEventListener('click', (e) => {
            if (e.target.matches('button')) {
                const tab = e.target.dataset.tab;
                document.querySelectorAll('#admin-tabs button').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                document.getElementById('tab-content-properties').classList.toggle('hidden', tab !== 'properties');
                document.getElementById('tab-content-users').classList.toggle('hidden', tab !== 'users');
            }
        });

        // --- CRUD & Actions ---
        const startEditProperty = (id) => {
            const prop = dbData.workspaces[currentUser.id]?.find(p => p.id == id);
            if (!prop) return;
            const form = adminPropertyFormEl.querySelector('form');
            form.reset();
            adminPropertyFormEl.querySelector('h2').textContent = 'Editar Empreendimento';
            for (const key in prop) {
                const field = form.querySelector(`#${key}`);
                if (field) {
                    if (Array.isArray(prop[key])) field.value = prop[key].join(', ');
                    else field.value = prop[key];
                }
            }
            const filesContainer = adminPropertyFormEl.querySelector('#files-container');
            filesContainer.innerHTML = '';
            prop.arquivos.forEach(file => addFileInput(file));
            showPage('page-admin-property-form');
        };

        const deleteProperty = (id) => {
            if (confirm('Tem a certeza que deseja apagar este empreendimento?')) {
                dbData.workspaces[currentUser.id] = dbData.workspaces[currentUser.id].filter(p => p.id != id);
                db.save();
                renderAll();
            }
        };

        document.getElementById('tab-content-properties').addEventListener('click', (e) => {
            const row = e.target.closest('tr');
            if (!row) return;
            const id = row.dataset.id;
            if (e.target.matches('.edit-btn')) startEditProperty(id);
            if (e.target.matches('.delete-btn')) deleteProperty(id);
        });

        document.getElementById('tab-content-users').addEventListener('click', (e) => {
            if (e.target.matches('.delete-user-btn')) {
                const row = e.target.closest('tr');
                const userId = row.dataset.id;
                if (confirm('Tem a certeza que deseja apagar este utilizador e todos os seus empreendimentos?')) {
                    dbData.users = dbData.users.filter(u => u.id != userId);
                    delete dbData.workspaces[userId];
                    db.save();
                    renderAll();
                }
            }
        });

        document.getElementById('addPropertyBtn').addEventListener('click', () => {
            const form = adminPropertyFormEl.querySelector('form');
            form.reset();
            form.querySelector('#property-id').value = '';
            adminPropertyFormEl.querySelector('h2').textContent = 'Adicionar Novo Empreendimento';
            adminPropertyFormEl.querySelector('#files-container').innerHTML = '';
            showPage('page-admin-property-form');
        });
        
        document.getElementById('addUserBtn').addEventListener('click', () => {
            adminUserFormEl.querySelector('form').reset();
            showPage('page-admin-user-form');
        });
        
        adminUserFormEl.querySelector('form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('user-email').value;
            if (dbData.users.some(u => u.email === email)) {
                alert('Este email já está registado.');
                return;
            }
            const newUser = { id: Date.now(), email: email, password: document.getElementById('user-password').value, role: document.getElementById('user-role').value, };
            dbData.users.push(newUser);
            dbData.workspaces[newUser.id] = [];
            db.save();
            renderAdminUserTable();
            showPage('admin');
        });

        const addFileInput = (file = null) => {
            const fileId = Date.now() + Math.random();
            const container = adminPropertyFormEl.querySelector('#files-container');
            container.insertAdjacentHTML('beforeend', `<div class="admin-form-grid" id="file-${fileId}" style="margin-bottom: 1rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem;"><div class="form-group"><label>Tipo</label><select class="form-control file-type"><option value="image" ${file?.tipo === 'image' ? 'selected' : ''}>Foto</option><option value="video" ${file?.tipo === 'video' ? 'selected' : ''}>Vídeo</option><option value="pdf" ${file?.tipo === 'pdf' ? 'selected' : ''}>PDF</option></select></div><div class="form-group"><label>Link</label><input type="url" class="form-control file-link" value="${file?.link || ''}" required></div><div class="form-group" style="align-self: flex-end;"><button type="button" class="btn btn-danger btn-small remove-file-btn" data-fileid="${fileId}">Remover</button></div></div>`);
        };

        adminPropertyFormEl.querySelector('#add-file-btn').addEventListener('click', () => addFileInput());
        adminPropertyFormEl.querySelector('#files-container').addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-file-btn')) {
                document.getElementById(`file-${e.target.dataset.fileid}`).remove();
            }
        });

        adminPropertyFormEl.querySelector('form').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('property-id').value;
            const files = [];
            adminPropertyFormEl.querySelectorAll('#files-container .admin-form-grid').forEach(fileEl => {
                const link = fileEl.querySelector('.file-link').value;
                if(link) files.push({ id: Date.now() + Math.random(), tipo: fileEl.querySelector('.file-type').value, link: link });
            });

            const formData = {
                emp_nome: document.getElementById('emp_nome').value, emp_apelido: document.getElementById('emp_apelido').value, emp_endereco: document.getElementById('emp_endereco').value, regiao: document.getElementById('regiao').value, emp_descricao: document.getElementById('emp_descricao').value, emp_itens_de_lazer: document.getElementById('emp_itens_de_lazer').value.split(',').map(item => item.trim()), emp_diferenciais: document.getElementById('emp_diferenciais').value.split(',').map(item => item.trim()), emp_metragens: document.getElementById('emp_metragens').value, emp_suites: document.getElementById('emp_suites').value, emp_banheiros: document.getElementById('emp_banheiros').value, emp_vagas: document.getElementById('emp_vagas').value, valor_inicial: parseFloat(document.getElementById('valor_inicial').value) || 0, valor_final: parseFloat(document.getElementById('valor_final').value) || 0, emp_status: document.getElementById('emp_status').value, emp_previsao: document.getElementById('emp_previsao').value, emp_construtora: document.getElementById('emp_construtora').value, emp_incorporadora: document.getElementById('emp_incorporadora').value, emp_arquitetura: document.getElementById('emp_arquitetura').value, emp_link: document.getElementById('emp_link').value, area_terreno: parseFloat(document.getElementById('area_terreno').value) || 0, area_construcao: parseFloat(document.getElementById('area_construcao').value) || 0, numero_torres: parseInt(document.getElementById('numero_torres').value) || 0, numero_apartamentos: parseInt(document.getElementById('numero_apartamentos').value) || 0, arquivos: files
            };

            if (id) {
                const index = dbData.workspaces[currentUser.id].findIndex(p => p.id == id);
                if (index !== -1) dbData.workspaces[currentUser.id][index] = { ...dbData.workspaces[currentUser.id][index], ...formData };
            } else {
                formData.id = Date.now();
                formData.ownerId = currentUser.id;
                if (!dbData.workspaces[currentUser.id]) dbData.workspaces[currentUser.id] = [];
                dbData.workspaces[currentUser.id].push(formData);
            }

            db.save();
            renderAll();
            showPage('admin');
        });
        
        // --- Init ---
        db.load();
        renderAll();
        updateNav();
        showPage('catalog');
    });
    </script>
</body>
</html>
